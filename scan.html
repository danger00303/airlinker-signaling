<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="icon.png" type="image/png">
  <title>Scan QR — Airlinker</title>

  <style>
    /* Airlinker theme — same aesthetic */
    :root {
      --bg: #f8f9fb;
      --card: #ffffff;
      --accent: #007aff;
      --muted: #6b7280;
      --radius: 16px;
    }

    * {
      box-sizing: border-box;
      font-family: Inter, system-ui, sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      padding: 32px;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 900px;
      max-width: 100%;
      background: var(--card);
      padding: 32px;
      border-radius: var(--radius);
      box-shadow: 0 12px 40px rgba(0,0,0,0.06);
      animation: fadeIn .3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      margin: 0;
      font-size: 26px;
      font-weight: 600;
    }

    p.sub {
      margin: 6px 0 20px;
      color: var(--muted);
    }

    .video-box {
      background: #000;
      border-radius: var(--radius);
      overflow: hidden;
      height: 380px;
      position: relative;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    canvas#overlay {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

.controls {
  margin-top: 14px;
  display: flex;
  flex-wrap: wrap;         /* allows wrapping */
  gap: 10px;
}

.controls button,
.controls label {
  flex: 1 1 calc(50% - 10px);     /* 2 items per row on mobile */
  text-align: center;
}

/* On very small phones (<400px) force 100% full width */
@media (max-width: 400px) {
  .controls button,
  .controls label {
    flex: 1 1 100%;
  }
}

/* Disable mobile tap highlight and focus outline */
* {
  -webkit-tap-highlight-color: transparent !important;
  -webkit-touch-callout: none !important;
}

button, a, label {
  outline: none !important;
  -webkit-tap-highlight-color: transparent !important;
}

*:focus {
  outline: none !important;
  box-shadow: none !important;
}

::selection {
  background: transparent !important;
}

    button {
      background: var(--accent);
      border: none;
      padding: 10px 18px;
      color: #fff;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      transition: opacity .2s;
    }

    button:disabled {
      opacity: .4;
      cursor: default;
    }

    .ghost {
      background: transparent;
      color: var(--accent);
      border: 1px solid rgba(0,0,0,0.08);
    }

    .result-box {
      margin-top: 22px;
      background: #f2f4f8;
      padding: 18px;
      border-radius: var(--radius);
      border: 1px solid rgba(0,0,0,0.04);
    }

    .result-label {
      font-size: 13px;
      color: var(--muted);
    }

    .result {
      margin-top: 5px;
      font-size: 15px;
      font-weight: 600;
      word-break: break-word;
    }
    .home-btn{
display:inline-flex;
align-items:center;
gap:6px;
margin-top:8px;
margin-bottom:20px;
color:var(--accent);
font-size:14px;
text-decoration:none;
padding:8px 14px;
border:1px solid rgba(0,0,0,0.12);
border-radius:12px;
background:#fff;
box-shadow:0 2px 8px rgba(0,0,0,0.04);
transition:background .2s, box-shadow .2s, transform .15s;
}
.home-btn:hover{
background:#f4f7fb;
box-shadow:0 4px 14px rgba(0,0,0,0.06);
}
.home-btn:active{
transform:scale(0.97);
}
.home-btn:hover{background:#f2f4f8;}
  </style>
</head>
<body>
  <div class="container">

<h1>Scan QR Code</h1>
<p class="sub">Use your desktop webcam to scan an Airlinker QR.</p>
<a href="index.html" class="home-btn">← Home</a>

    <div class="video-box">
      <video id="video" autoplay playsinline></video>
      <canvas id="overlay"></canvas>
    </div>

<div class="controls">
  <button id="startBtn">Start Camera</button>
  <button id="flipBtn" class="ghost" disabled>Flip Camera</button>
  <button id="stopBtn" class="ghost" disabled>Stop</button>

  <label class="ghost" style="padding: 10px 16px; border-radius: 10px; cursor:pointer;">
    Pick Image
    <input id="fileInput" type="file" accept="image/*" style="display:none;" />
  </label>
</div>

    <div class="result-box">
      <div class="result-label">Scanned Result</div>
      <div id="result" class="result">Nothing scanned yet.</div>
    </div>

    <canvas id="hidden" style="display:none;"></canvas>

    <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

    <script>
      const video = document.getElementById("video");
      const overlay = document.getElementById("overlay");
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const fileInput = document.getElementById("fileInput");
      const resultBox = document.getElementById("result");
      const hidden = document.getElementById("hidden");

    let currentFacing = "environment"; // default to back on mobile
    const flipBtn = document.getElementById("flipBtn");

      let stream = null;
      let scanning = false;
      let ctx = overlay.getContext("2d");

startBtn.onclick = async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: currentFacing }
    });

    video.srcObject = stream;

    await video.play();

    scanning = true;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    flipBtn.disabled = false; // enable flip

    scanLoop();

  } catch (err) {
    alert("Camera error: " + err.message);
  }
};


      stopBtn.onclick = () => {
        if (stream) stream.getTracks().forEach(t => t.stop());
        scanning = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
        ctx.clearRect(0,0,overlay.width,overlay.height);
      };

      flipBtn.onclick = async () => {
  if (!stream) return;

  // Stop old stream
  stream.getTracks().forEach(t => t.stop());

  // Switch facing mode
  currentFacing = currentFacing === "environment" ? "user" : "environment";

  // Restart camera
  startBtn.onclick();
};


function scanLoop() {
  if (!scanning) return;

  if (video.videoWidth === 0 || video.videoHeight === 0) {
    return requestAnimationFrame(scanLoop); // Wait until ready
  }

  overlay.width = video.videoWidth;
  overlay.height = video.videoHeight;

  ctx.drawImage(video, 0, 0, overlay.width, overlay.height);

  const imgData = ctx.getImageData(0, 0, overlay.width, overlay.height);
  const code = jsQR(imgData.data, overlay.width, overlay.height);

  if (code) {
    drawBox(code.location);
    handleResult(code.data);
  }

  requestAnimationFrame(scanLoop);
}


      function drawBox(loc) {
        ctx.lineWidth = 4;
        ctx.strokeStyle = "#00ff4c";
        ctx.beginPath();
        ctx.moveTo(loc.topLeftCorner.x, loc.topLeftCorner.y);
        ctx.lineTo(loc.topRightCorner.x, loc.topRightCorner.y);
        ctx.lineTo(loc.bottomRightCorner.x, loc.bottomRightCorner.y);
        ctx.lineTo(loc.bottomLeftCorner.x, loc.bottomLeftCorner.y);
        ctx.closePath();
        ctx.stroke();
      }

      function handleResult(text) {
        resultBox.textContent = text;
        if (text.startsWith("http")) {
          window.location.href = text;
        }
      }

      fileInput.onchange = () => {
        const file = fileInput.files[0];
        if (!file) return;

        const img = new Image();
        img.onload = () => {
          hidden.width = img.width;
          hidden.height = img.height;
          const hCtx = hidden.getContext("2d");
          hCtx.drawImage(img, 0, 0);

          const data = hCtx.getImageData(0, 0, img.width, img.height);
          const code = jsQR(data.data, img.width, img.height);

          if (code) handleResult(code.data);
          else alert("No QR code found in image.");
        };
        img.src = URL.createObjectURL(file);
      };
    </script>

  </div>
</body>
</html>
